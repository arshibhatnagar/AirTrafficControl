<!DOCTYPE html>
<html>
  <head>
    <title>Simple Map</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 100%;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  </head>
  <body>
    <div id="map"></div>
    <script>
      var map;
      var marker;
      var waypoint_marker;
      var myLatLng = {lat: 42.36305577000002, lng: -71.00696199};
      var lastWaypoint = {lat: 42.36305577000002, lng: -71.00696199};
      var currentWaypoint = {lat: 42.77981700000001, lng: -73.372475};
      var flightInfo = {"flight_num": "AI973","latitude": 42.36305577000002, "longitude": -71.00696199,"speed": 975.0, "altitude": 5000.0, "temperature": 32.0, "flight_key_urlsafe": "aghkZXZ-Tm9uZXITCxIGRmxpZ2h0GICAgICA4JcKDA", "flight_waypoints_key_urlsafe": "aghkZXZ-Tm9uZXIcCxIPRmxpZ2h0V2F5cG9pbnRzGICAgICA4JcJDA"};
      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          center: myLatLng,
          zoom: 7
        });
        marker = new google.maps.Marker({
            position: myLatLng,
            map: map,
            title: 'Hello World!',
            icon: 'http://maps.google.com/mapfiles/ms/icons/plane.png'
          });
        $.ajax({
            type: 'POST',
            url: 'http://localhost:8080/flight',
            data: JSON.stringify(flightInfo), // or JSON.stringify ({name: 'jonas'}),
            success: function(data) {
                // flightInfo["latitude"] = data["Waypoint"][0];
                // flightInfo["longitude"] = data["Waypoint"][1];
                // myLatLng["lat"] = data["Waypoint"][0];
                // myLatLng["lon"] = data["Waypoint"][1];
                // marker.setPosition(myLatLng);
                waypoint_marker = new google.maps.Marker({
                    position: {lat: data["Waypoint"][0], lng: data["Waypoint"][1]},
                    map: map,
                    title: 'Hello World!'
                  });
                // console.log(data);
                sendFlightInfo(data);
                // console.log(data["flight_key_urlsafe"]);
                // console.log(data["flight_waypoints_key_urlsafe"]);
            },
            contentType: "application/json",
            dataType: 'json'
        });
      }
      function sendFlightInfo(data) {
        // console.log(currentWaypoint);
        if (Math.abs(flightInfo["latitude"] - data["Dest Waypoint"][0]) < 0.1 && Math.abs(flightInfo["longitude"] - data["Dest Waypoint"][1]) < 0.1) {
            return;
        }
        if (data["Waypoint"][0] != currentWaypoint["lat"] && data["Waypoint"][1] != currentWaypoint["lng"]) {
            console.log("in if");
            console.log(data["Waypoint"]);
            console.log(lastWaypoint);
            console.log(currentWaypoint);
            lastWaypoint["lat"] = currentWaypoint["lat"];
            lastWaypoint["lng"] = currentWaypoint["lng"];
            currentWaypoint["lat"] = data["Waypoint"][0];
            currentWaypoint["lng"] = data["Waypoint"][1];
        }
        var latitude = myLatLng["lat"] + (data["Waypoint"][0] - lastWaypoint["lat"])/100.0;
        var longitude = myLatLng["lng"] + (data["Waypoint"][1] - lastWaypoint["lng"])/100.0;
        myLatLng["lat"] = latitude;
        myLatLng["lng"] = longitude;
        flightInfo["latitude"] = latitude.toString();
        flightInfo["longitude"] = longitude.toString();
        marker.setPosition(myLatLng);
         waypoint_marker.setPosition({lat: data["Waypoint"][0], lng: data["Waypoint"][1]});
        $.ajax({
            type: 'POST',
            url: 'http://localhost:8080/flight',
            data: JSON.stringify(flightInfo), // or JSON.stringify ({name: 'jonas'}),
            success: function(data) {
                sendFlightInfo(data);
            },
            contentType: "application/json",
            dataType: 'json'
        });
      }

    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBdA9c4g3FXJAdYsx6UD6SbZRXCfLGcgwc&callback=initMap"
    async defer></script>
  </body>
</html>